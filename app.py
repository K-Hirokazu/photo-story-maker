import streamlit as st
import google.generativeai as genai
from PIL import Image
from streamlit_image_select import image_select
import os
import json
import re
import zipfile
import io
import random
import tempfile

# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(
    page_title="AI Photo Story Curator",
    page_icon="ğŸ“¸",
    layout="wide"
)

# --- ã‚«ã‚¹ã‚¿ãƒ CSS ---
st.markdown("""
<style>
    .stButton>button {
        width: 100%;
        border-radius: 20px;
        font-weight: bold;
        height: 3em;
    }
    div[data-testid="column"] button {
        height: auto;
        min_height: 3em;
    }
</style>
""", unsafe_allow_html=True)

# --- ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ– ---
if 'patterns' not in st.session_state:
    st.session_state.patterns = None
if 'target_name' not in st.session_state:
    st.session_state.target_name = None
if 'generated_mode' not in st.session_state:
    st.session_state.generated_mode = None # "manual" or "random"

# --- ã‚¿ã‚¤ãƒˆãƒ« ---
st.title("ğŸ“¸ AI Photo Story Curator")
st.caption("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸå†™çœŸç¾¤ã‹ã‚‰ã€AIãŒã€Œæœ€é«˜ã®4æšã€ã‚’é¸ã³å‡ºã—ã€ç‰©èªã‚’ç´¡ãã¾ã™ã€‚")

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ ---
with st.sidebar:
    st.header("âš™ï¸ è¨­å®š")
    api_key = st.text_input("Gemini API Key", type="password", help="Google AI Studioã§å–å¾—ã—ãŸã‚­ãƒ¼")
    st.markdown("[ğŸ”‘ APIã‚­ãƒ¼å–å¾—](https://aistudio.google.com/app/apikey)")
    st.divider()
    st.info("ğŸ’¡ å†™çœŸã‚’ä¸€åº¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚Œã°ã€ä½•åº¦ã§ã‚‚ç”Ÿæˆã§ãã¾ã™ã€‚")

# --- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼šã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ---
uploaded_files = st.file_uploader(
    "1. å†™çœŸã‚’ã¾ã¨ã‚ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (20æšã€œ100æšæ¨å¥¨)", 
    accept_multiple_files=True, 
    type=['jpg', 'jpeg', 'png', 'heic', 'webp']
)

# --- é–¢æ•°: åå‰ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾— ---
def get_file_by_name(name, file_list):
    for f in file_list:
        if f.name == name:
            f.seek(0)
            return f
    return None

# --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
if uploaded_files:
    # --- 2. ã‚®ãƒ£ãƒ©ãƒªãƒ¼é¸æŠ ---
    st.markdown("### 2. ã€Œæ ¸ã€ã¨ãªã‚‹å†™çœŸã‚’é¸ã¶ï¼ˆã¾ãŸã¯ãŠã¾ã‹ã›ï¼‰")
    
    preview_imgs = []
    display_limit = 100 
    file_names = [f.name for f in uploaded_files[:display_limit]]

    for f in uploaded_files[:display_limit]:
        f.seek(0)
        img = Image.open(f)
        img.thumbnail((150, 150))
        preview_imgs.append(img)

    # ã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤º
    selected_index = image_select(
        label="",
        images=preview_imgs,
        captions=file_names,
        index=0,
        return_value="index",
        use_container_width=False
    )
    
    manual_target_file = uploaded_files[selected_index]

    # --- 3. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ ---
    st.markdown("### 3. ç”Ÿæˆã‚¹ã‚¿ãƒ¼ãƒˆ")
    col1, col2 = st.columns(2)
    
    start_generation = False
    selected_target = None
    is
